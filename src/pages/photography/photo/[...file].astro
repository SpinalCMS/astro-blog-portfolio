---
// modules
import { SEO } from "astro-seo";
import fg from "fast-glob"

// components
import BaseHead from "@/components/BaseHead"
import BaseLayout from "@/components/BaseLayout"
import Heading from "@/components/Heading"
import Flex from "@/components/Flex"
import Content from "@/components/Content"
import Container from "@/components/Container"
import Image from "@/components/image/Image"
import Caption from "@/components/image/Caption"

// functions
import { getMetadata, buildPublicPath, buildFileDetailPath } from "@/functions/Media"
import { fullDate } from "@/functions/DateTime"

// config
import { siteConfig, imageConfig } from "@/src/config.ts"

export async function getStaticPaths() {
    const files = fg.sync("./public/images/shoots/**/*.jpg"); // glob to get all the photo shoots
    const removePath = "./public/images/" // we need to remove the string from the file path above
    const removeChar = removePath.length;  // how many characters to trim off the file path

    const final = files.map(f => {
        const fullPath = buildFileDetailPath(f);

        return fullPath.slice(removeChar);
    })

    return final.map(f => ({ params: { file: f } }))
}

const { params } = Astro.request;

// add the filename back to the file param
// this is the local file
const url = params.file + ".jpg"

// the url of the image to create the download links
const ucr = buildPublicPath(params.file) + ".jpg";

// get the metadata for the file
const metadata = await getMetadata(url);
---

<!DOCTYPE html>
<html lang="en">
<head>
    <BaseHead />
    <SEO
        title={`${metadata.title} Photo - Erik S. Olsen`}
        description={`${metadata.caption}`}
    />

    <style>
        table, tr, td {
            @apply border
        }
        td {
            @apply px-4 py-2
        }
    </style>
</head>

<body>
    <BaseLayout>        
        <Content fullWidth={true}>
            <Container>
                <Heading>
                    <h1 slot="heading">{metadata.title}</h1>
                    <p slot="description">{metadata.caption}</p>
                </Heading>
            </Container>

            <Container>
                <Image
                    file={url}
                />
            </Container>

            <Container>
                <div>
                    <div class="flex justify-between">
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="space-y-8">
                                <h4>Camera Metadata</h4>
                                <table class="border-collapse table-auto">
                                    <tbody>
                                        <tr>
                                            <td>Date</td>
                                            <td>
                                                <date>{fullDate(metadata.date)}</date>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Author</td>
                                            <td>{metadata.author}</td>
                                        </tr>
                                        <tr>
                                            <td>Camera</td>
                                            <td>{metadata.cameraMake} {metadata.cameraModel}</td>
                                        </tr>
                                        <tr>
                                            <td>Lens</td>
                                            <td>{metadata.lens}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="space-y-8">
                                <h4>Photo Metadata</h4>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td>Aperture</td>
                                            <td>f/{metadata.aperture}</td>
                                        </tr>
                                        <tr>
                                            <td>ISO</td>
                                            <td>{metadata.iso}</td>
                                        </tr>
                                        <tr>
                                            <td>Focal Length</td>
                                            <td>{metadata.focalLength}mm</td>
                                        </tr>
                                        <tr>
                                            <td>Shutter Speed</td>
                                            <td>{metadata.shutterSpeed}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="space-y-8">
                                <h4>Download</h4>
                                <p><a href={`${imageConfig.ucEndpoint}/-/overlay/${imageConfig.logo}/10%25x10%25/50%25,98%25/${siteConfig.url}${ucr}`} title="Download the full size image">Full Size</a> ({metadata.width} x {metadata.height})</p>
                            </div>
                        </div>
                    </div>
                </div>
            </Container>
        </Content>
    </BaseLayout>
</body>
</html>