---
// modules
import fs from 'fs'
import moment from 'moment'
import exifr from 'exifr'

// data
import settings from "../../data/settings.json"

// props
export interface Props {
    file: string;
}
const { file } = Astro.props;

let localUrl = `${settings.image.directory.local}${file}`;

// collect all the exif and iptc data from the image
let exifrOptions = {
    iptc: ['ObjectName', 'Caption', 'Byline'],
    exif: ['LensModel', 'FNumber', 'ISO', 'ExposureTime', 'DateTimeOriginal', 'FocalLength'],
    ifd0: ['Make', 'Model'],
    gps: false,
    mergeOutput: true
}

var fsFile = fs.readFileSync(localUrl);
var metadata = await exifr.parse(fsFile, exifrOptions);

const captureDate = moment(metadata.DateTimeOriginal).format("dddd, MMMM Do YYYY, h:mm:ss a");
const exposure = 1 / metadata.ExposureTime;
---

<style lang="scss">
    @use '../../assets/styles/breakpoints' as *;

    figcaption {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        margin-top: var(--space-xs);

        .title {
            font-weight: 500;
        }
    }

    .modal-container {
        visibility: hidden;
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.075, 0.82, 0.165, 1);

        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;

        &:target {
            visibility: visible;
            opacity: 1;
        }
        &:target .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal {
            opacity: 0;
            transform: translateY(-1rem);
            transition: all 0.3s cubic-bezier(0.075, 0.82, 0.165, 1);
            transition-delay: 0.2s;

            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            z-index: 1;
            background-color: var(--color-white);
            width: 90%;
            max-width: 500px;
            padding: var(--space-lg);
            border-radius: var(--site-radius);

            .h1, p { margin: 0; }

            hr {
                width: 10%; 
                margin: 0;
            }
            
            .metadata {
                display: flex;
                flex-direction: column;
                gap: var(--space-md);

                p {
                    margin: 0;
                    font-size: var(--text-sm);
                }
            }

            .modal-close {
                position: absolute;
                top: -.5em;
                right: -.5em;
            }
        }

        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.2);
        }
    }
</style>

<figcaption>
    <div class="title">
        {metadata.ObjectName}
    </div>
    <div class="actions">
        <a href="#photoDetails">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </svg>
        </a>
    </div>

    <div class="modal-container" id="photoDetails">
        <div class="modal">
            <div>
                <p class="h1">{metadata.ObjectName}</p>
                <p>{metadata.Caption}</p>
            </div>

            <hr />

            <div class="metadata">
                <div>
                    <p><strong>Date</strong>: {captureDate}</p>
                    <p><strong>Photographer</strong>: {metadata.Byline}</p>
                </div>
                <div>
                    <p><strong>Camera</strong>: {metadata.Make} {metadata.Model}</p>
                    <p><strong>Lens</strong>: {metadata.LensModel}</p>
                </div>
                <div>
                    <p><strong>Aperture</strong>: {metadata.FNumber}</p>
                    <p><strong>ISO</strong>: {metadata.ISO}</p>
                    <p><strong>Exposure</strong>: 1/{exposure}</p>
                </div>
            </div>

            <a href="#" title="Close" class="modal-close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                </svg>
            </a>
        </div>
        
        <a href="#" class="modal-bg"></a>
    </div>
</figcaption>